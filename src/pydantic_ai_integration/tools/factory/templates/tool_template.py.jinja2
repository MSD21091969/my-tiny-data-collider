"""Auto-generated tool: {{ tool.name }}

Generated from: config/tools/{{ tool.name }}.yaml
DO NOT EDIT THIS FILE MANUALLY - Changes will be overwritten

This tool is part of the pydantic_ai_integration tool engineering foundation.
It was generated by the Tool Factory and automatically registered with MANAGED_TOOLS.
"""
from pydantic import BaseModel, Field
from typing import Dict, Any, Optional, List
from ...tool_decorator import register_mds_tool
from ...dependencies import MDSContext
{% if tool.implementation.type == 'composite' %}
from ..chain_executor import ChainExecutor
{% endif %}


class {{ tool.name | capitalize | replace('_', '') }}Params(BaseModel):
    """Parameters for {{ tool.name }}.
    
    {{ tool.description }}
    """
    {% for param in tool.parameters %}
    {{ param.name }}: {% if not param.required %}Optional[{% endif %}{{ param.python_type }}{% if not param.required %}]{% endif %} = Field(
        {% if param.required %}...{% else %}{{ param.default_value }}{% endif %},
        {% if param.min_value is defined %}ge={{ param.min_value }},{% endif %}
        {% if param.max_value is defined %}le={{ param.max_value }},{% endif %}
        {% if param.min_length is defined %}min_length={{ param.min_length }},{% endif %}
        {% if param.max_length is defined %}max_length={{ param.max_length }},{% endif %}
        description="{{ param.description }}"
    )
    {% endfor %}

    class Config:
        json_schema_extra = {
            "examples": [
                {
                    {% for param in tool.parameters %}
                    "{{ param.name }}": {{ param.example_value }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                }
            ]
        }


@register_mds_tool(
    name="{{ tool.name }}",
    display_name="{{ tool.display_name }}",
    description="{{ tool.description }}",
    category="{{ tool.category }}",
    version="{{ tool.version }}",
    tags={{ tool.tags }},
    enabled={{ tool.business_rules.enabled | capitalize }},
    requires_auth={{ tool.business_rules.requires_auth | capitalize }},
    required_permissions={{ tool.business_rules.required_permissions }},
    requires_casefile={{ tool.business_rules.requires_casefile | capitalize }},
    timeout_seconds={{ tool.business_rules.timeout_seconds }},
    params_model={{ tool.name | capitalize | replace('_', '') }}Params,
    {% if tool.session_policies %}
    session_policies={{ tool.session_policies }},
    {% endif %}
    {% if tool.casefile_policies %}
    casefile_policies={{ tool.casefile_policies }},
    {% endif %}
    {% if tool.audit_events %}
    audit_config={{ tool.audit_events }},
    {% endif %}
)
async def {{ tool.name }}(
    ctx: MDSContext,
    {% for param in tool.parameters %}
    {{ param.name }}: {{ param.python_type }}{% if not param.required %} = {{ param.default_value }}{% endif %}{% if not loop.last %},{% endif %}
    {% endfor %}
) -> Dict[str, Any]:
    """{{ tool.description }}
    
    Args:
        ctx: MDSContext with user_id, session_id, etc.
        {% for param in tool.parameters %}
        {{ param.name }}: {{ param.description }}
        {% endfor %}
    
    Returns:
        Dict containing execution results
    """
    # Register event for audit trail
    event_id = ctx.register_event(
        "{{ tool.name }}",
        {
            {% for param in tool.parameters %}
            "{{ param.name }}": {{ param.name }}{% if not loop.last %},{% endif %}
            {% endfor %}
        }
    )
    
    {% if tool.implementation.type == 'simple' %}
    # Simple implementation
    {% if tool.implementation.simple and tool.implementation.simple.logic %}
    {{ tool.implementation.simple.logic | indent(4) }}
    {% else %}
    # Default simple result
    result = {
        "tool": "{{ tool.name }}",
        "status": "success",
        {% for param in tool.parameters %}
        "{{ param.name }}": {{ param.name }}{% if not loop.last %},{% endif %}
        {% endfor %}
    }
    {% endif %}
    
    {% elif tool.implementation.type == 'composite' %}
    # Composite tool implementation - execute chain of tools
    executor = ChainExecutor(ctx)
    
    # Prepare initial state from input parameters
    initial_state = {
        {% for param in tool.parameters %}
        "{{ param.name }}": {{ param.name }},
        {% endfor %}
    }
    
    # Define chain steps
    steps = {{ tool.implementation.composite.steps | tojson }}
    
    # Execute chain
    chain_result = await executor.execute_chain(
        steps=steps,
        initial_state=initial_state,
        chain_name="{{ tool.name }}"
    )
    
    # Format result
    result = {
        "tool": "{{ tool.name }}",
        "status": "success" if chain_result.get("success") else "failure",
        "chain_id": chain_result.get("chain_id"),
        "steps_executed": chain_result.get("steps_executed"),
        "data": chain_result
    }
    
    {% elif tool.implementation.type == 'api_call' and tool.implementation.api_call %}
    # API call implementation
    from {{ tool.implementation.api_call.client_module }} import {{ tool.implementation.api_call.client_class }}
    {% if tool.implementation.api_call.request_type %}
    from {{ tool.implementation.api_call.client_module.replace('.clients', '.models') }} import {{ tool.implementation.api_call.request_type }}
    {% endif %}
    
    # Initialize client
    client = {{ tool.implementation.api_call.client_class }}(user_id=ctx.user_id)
    
    # Build request
    {% if tool.implementation.api_call.request_type %}
    request = {{ tool.implementation.api_call.request_type }}(
        {% for param in tool.parameters %}
        {{ param.name }}={{ param.name }}{% if not loop.last %},{% endif %}
        {% endfor %}
    )
    response = await client.{{ tool.implementation.api_call.method_name }}(request=request)
    {% else %}
    response = await client.{{ tool.implementation.api_call.method_name }}(
        {% for param in tool.parameters %}
        {{ param.name }}={{ param.name }}{% if not loop.last %},{% endif %}
        {% endfor %}
    )
    {% endif %}
    
    # Convert response to dict
    result = response.model_dump() if hasattr(response, 'model_dump') else response
    
    {% else %}
    # Placeholder for {{ tool.implementation.type }} implementation
    result = {
        "tool": "{{ tool.name }}",
        "status": "success",
        "implementation_type": "{{ tool.implementation.type }}",
        {% for param in tool.parameters %}
        "{{ param.name }}": {{ param.name }}{% if not loop.last %},{% endif %}
        {% endfor %}
    }
    {% endif %}
    
    # Update audit trail
    if ctx.tool_events:
        last_event = ctx.tool_events[-1]
        last_event.result_summary = {
            "status": "success",
            "result_preview": str(result)[:100]
        }
        last_event.status = "success"
    
    return result
